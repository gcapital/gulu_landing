from django.template import RequestContext
from django.shortcuts import render_to_response, redirect, get_object_or_404
from django.conf import settings
from django.http import HttpResponseRedirect, Http404
from django.contrib.auth.decorators import login_required
from piston.models import Sync, Site
from urllib import urlencode
import cgi
import external_apps.oauth2 as oauth
import httplib2


#http://gulu.demo.gd/api/oauth_facebook_request
#http://gulu.demo.gd/api/oauth_handle_token/twitter/
#http://localhost:8000/api/oauth_ask_approve/twitter/

#api_key: EQfYJUeeZFtQTF8CSh4g
#oauth_token=LxGS1bqcsN1czPwLAQCaVDrLcKholIGrPsPWWkm1M8&oauth_verifier=RyoZMLRKOC5zBzvNVCTsDS7ufbF2I5c8ycPksUxpF4
        
#http://gulu.demo.gd/api/oauth_facebook_accept
"""
https://www.facebook.com/dialog/oauth?client_id=176639869044279&redirect_uri=http://test.com/&scope=publish_stream,read_stream,user_status,user_videos,user_events,user_photos,email,user_groups,offline_access
code=2.4r_3lPdR0nTXTcnZtlohJA__.3600.1296464400-702945634%7Cg1JmtbNhj2ByCrmuROsRyTf7m_Q
https://graph.facebook.com/oauth/access_token?client_id=176639869044279&redirect_uri=http://test.com/&client_secret=7306e282380c308f60c4eae2b44c4d9c&code=2.4r_3lPdR0nTXTcnZtlohJA__.3600.1296464400-702945634%7Cg1JmtbNhj2ByCrmuROsRyTf7m_Q
access_token=176639869044279|2.4r_3lPdR0nTXTcnZtlohJA__.3600.1296464400-702945634|-jwavx4ANHlHZzq9L0zSHyOHZLc&expires=4845
 https://graph.facebook.com/me?access_token=176639869044279|2.4r_3lPdR0nTXTcnZtlohJA__.3600.1296464400-702945634|-jwavx4ANHlHZzq9L0zSHyOHZLc&expires=4845 
"""
"""
1. http://localhost:8000/api/oauth_facebook_request
2. http://localhost:8000/api/oauth_facebook_access
"""
@login_required
def oauth_facebook_request(request):
    site_o = get_object_or_404(Site, name = 'facebook')
    sync_list = Sync.objects.filter(site=site_o, user = request.user)
    if sync_list:
        return HttpResponseRedirect("http://localhost:8000/api/facebook_error")
    facebook_url = "https://www.facebook.com/dialog/oauth?"    
    data = {'client_id':site_o.key,'redirect_uri':'http://test.com/', 
            'scope':'publish_stream,read_stream,user_status,user_videos,user_events,user_photos,email,user_groups,offline_access'}
    #callback_url = urlencode(unicode('http://gulu.demo.gd/api/oauth_facebook_accept'))
    #command = "&scope=publish_stream,read_stream,user_status,user_videos,user_events,user_photos,email,user_groups,offline_access"    
    parameter = urlencode(data)
    url = facebook_url+parameter
    return HttpResponseRedirect(url)

@login_required    
def oauth_facebook_access(request):
    if request.GET.get('code'):
        code = request.GET.get('code')
    else: 
        raise Http404
    site_o = get_object_or_404(Site, name = 'facebook')
    sync_o = Sync(user=request.user, site = site_o, verifier = code)
    sync_o.save()
    #https://graph.facebook.com/oauth/access_token?client_id=176639869044279&redirect_uri=http://test.com/&client_secret=7306e282380c308f60c4eae2b44c4d9c&code=d5a27fca9699c3e6720a460d-702945634%7CiTBoDnhUFO6-GYA4dbRY2GBiGUQ
    facebook_url = 'https://graph.facebook.com/oauth/access_token?'
    #data = {'client_id':site_o.api_key,'redirect_uri':'http://test.com/',
    #        'client_secret':site_o.secret}
    data = {'client_id':site_o.key,'redirect_uri':'http://test.com/',
            'client_secret':site_o.secret,'code':code}
    parameter = urlencode(data)
    url = facebook_url+parameter
    #body = ''
    h = httplib2.Http(".cache")
    resp, content = h.request(url, "GET")
    #content = conn.getresponse()
    #content = HTTPConnection.request('POST', url, body)
    resp_dict = dict(cgi.parse_qsl(content))
    sync_o.is_access = True
    sync_o.token = resp_dict['access_token']
    sync_o.save()
    error_msg = None
    print resp_dict['access_token']
    return render_to_response('oauth_success.html', {
        'site_name' : 'facebook',
        'error_msg': error_msg,
    }, context_instance = RequestContext(request))
"""
@login_required    
def oauth_facebook_accept(request):
    #code=198e8d46cb58f8490f61a1ce-702945634%7Cm7XofI_Pdyg4j3EsZqJ4xEkZBdg
    if request.GET.get('access_token'):
        access_token = request.GET.get('access_token')
    else: 
        raise Http404
    site_o = get_object_or_404(Site, name = 'facebook')
    sync_o = Sync(user=request.user, site = site_o, token = access_token)
    sync_o.is_access = True
    sync_o.save()
    error_msg = None
    return render_to_response('oauth_success.html', {
        'site_name' : 'facebook',
        'error_msg': error_msg,
    }, context_instance = RequestContext(request))
"""